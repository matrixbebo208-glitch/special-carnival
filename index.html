<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Jo | Ultimate Cloud POS</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --p: #6366f1; --s: #10b981; --d: #ef4444;
            --bg: #f8fafc; --card: #ffffff; --t: #0f172a; --m: #64748b;
        }
        [data-theme="dark"] {
            --bg: #020617; --card: #0f172a; --t: #f1f5f9; --m: #94a3b8;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: Cairo; }
        body { background: var(--bg); color: var(--t); transition: .3s; overflow: hidden; }
        
        .loader { position:fixed; inset:0; background:#020617; display:flex; align-items:center; justify-content:center; z-index:9999; }
        .spinner { width:50px; height:50px; border:5px solid #1e293b; border-top:5px solid var(--p); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page { display:none; height:100vh; }
        .page.active { display:block; }
        
        .layout { display:flex; height:100vh; }
        .sidebar { width:260px; background:#0f172a; color:#fff; padding:25px; display:flex; flex-direction:column; }
        .nav { padding:14px; border-radius:12px; color:#94a3b8; margin-bottom:8px; cursor:pointer; display:flex; align-items:center; gap:10px; }
        .nav.active, .nav:hover { background:#1e293b; color:#fff; }
        
        .content { flex:1; padding:30px; overflow:auto; }
        .card { background:var(--card); padding:25px; border-radius:18px; box-shadow:0 10px 25px rgba(0,0,0,.05); margin-bottom:20px; }
        
        input { width:100%; padding:12px; border-radius:10px; border:1px solid #e5e7eb; margin-bottom:10px; outline:none; background:var(--bg); color:var(--t); }
        button { padding:12px 20px; border-radius:10px; border:none; cursor:pointer; font-weight:700; transition:.2s; }
        .btn-p { background:var(--p); color:#fff; }
        .btn-s { background:var(--s); color:#fff; }
        .btn-d { background:var(--d); color:#fff; }

        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th, td { text-align:center; padding:12px; border-bottom:1px solid rgba(0,0,0,0.05); }

        @media print { body * { visibility:hidden; } #print, #print * { visibility:visible; } #print { position:absolute; top:0; left:0; width:100%; } }
    </style>
</head>
<body>

<div id="loader" class="loader"><div class="spinner"></div></div>

<div id="auth-page" class="page active">
    <div style="height:100vh; display:flex; align-items:center; justify-content:center; background:#0f172a">
        <div class="card" style="width:380px; text-align:center">
            <h1 style="color:var(--p)">Matrix Jo</h1>
            <p style="color:var(--m); margin-bottom:20px">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</p>
            <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-p" style="width:100%" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>
</div>

<div id="app-page" class="page">
    <div class="layout">
        <aside class="sidebar">
            <h2 style="color:var(--p); text-align:center; margin-bottom:30px">Matrix Jo</h2>
            <div class="nav active" onclick="view('pos', event)">ğŸ–¥ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</div>
            <div class="nav" onclick="view('rep', event)">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
            <div class="nav" onclick="view('support', event)">ğŸ’¬ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</div>
            <div id="master-nav" class="nav" style="display:none; color:gold" onclick="view('master', event)">ğŸ‘‘ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</div>
            <button class="btn-d" style="margin-top:auto" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </aside>

        <main class="content">
            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px">
                <div><h2 id="store-name">...</h2><small id="user-email" style="color:var(--m)"></small></div>
                <div id="clock" style="font-weight:bold"></div>
            </header>

            <div id="pos-view">
                <div id="lock-msg" class="card" style="display:none; border:2px solid var(--d); background:#fff1f1">
                    <h3 style="color:var(--d)">âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªÙˆÙ‚Ù</h3>
                    <p>ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹.</p>
                    <button class="btn-p" onclick="view('support')">Ø§Ø·Ù„Ø¨ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„</button>
                </div>

                <div id="pos-content">
                    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px">
                        <div class="card">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª<h2 id="sSales">0</h2></div>
                        <div class="card">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­<h2 id="sProfit">0</h2></div>
                        <div class="card">Ø§Ù„ÙÙˆØ§ØªÙŠØ±<h2 id="sCount">0</h2></div>
                    </div>
                    <div class="card">
                        <h3>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h3>
                        <div style="display:flex; gap:10px; margin-top:10px">
                            <input id="pname" placeholder="Ø§Ù„Ø§Ø³Ù…" style="flex:3">
                            <input id="pbuy" type="number" placeholder="Ø´Ø±Ø§Ø¡">
                            <input id="psell" type="number" placeholder="Ø¨ÙŠØ¹">
                            <button class="btn-p" onclick="add()">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <table>
                            <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>X</th></tr></thead>
                            <tbody id="cart"></tbody>
                        </table>
                        <div style="display:flex; justify-content:space-between; margin-top:20px; align-items:center">
                            <h2>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0</span></h2>
                            <button class="btn-s" onclick="checkout()">Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø©</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="rep-view" style="display:none">
                <div class="card"><h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3><div id="list"></div></div>
            </div>

            <div id="support-view" style="display:none">
                <div class="card">
                    <h3>ğŸ’¬ Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„ØªÙØ¹ÙŠÙ„</h3>
                    <p style="margin:15px 0">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: <span id="status-txt">...</span></p>
                    <p id="expiry-txt" style="font-size:12px; color:var(--m)"></p>
                    <hr style="margin:15px 0; opacity:0.1">
                    <input id="act-key" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (XXXX XXXX)">
                    <button class="btn-p" style="width:100%" onclick="activate()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø©</button>
                    <a href="https://wa.me/201224815487?text=Ø§Ù„Ø³Ù„Ø§Ù…%20Ø¹Ù„ÙŠÙƒÙ…%20ØŒ%20Ø­Ø§Ø¨Ø¨%20Ø£Ø³ØªÙØ³Ø±%20Ø¹Ù†%20Ø§Ù„Ø®Ø¯Ù…Ø©" target="_blank" class="btn-s" style="display:block; text-align:center; margin-top:10px; text-decoration:none">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Matrix Jo Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
                </div>
            </div>

            <div id="master-view" style="display:none">
                <div class="card">
                    <h2 style="color:gold">ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>
                    <table>
                        <thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                        <tbody id="master-list"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="print">
    <center>
        <h1>Matrix Jo</h1>
        <p id="pStore"></p><hr>
        <table id="pTable" style="width:100%"></table><hr>
        <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="pTotal"></span></h3>
        <p id="pDate"></p>
    </center>
</div>

<script>
/* CONFIG */
const MASTER_EMAIL = "matrixbebo208@gmail.com";
firebase.initializeApp({
    apiKey: "AIzaSyCzVhJNBC-AWGobCLUrRKdBE3OnmUj2H5HI",
    authDomain: "matrix-pos-e7336.firebaseapp.com",
    projectId: "matrix-pos-e7336"
});
const auth = firebase.auth();
const db = firebase.firestore();

let cart = [], userData = null;

/* AUTH MONITOR */
auth.onAuthStateChanged(async u => {
    if(u) {
        const d = await db.collection("users").doc(u.uid).get();
        userData = d.data();
        if(!userData) { // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            userData = { name: "Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯", email: u.email, active: false, role: 'user', expiry: '' };
            await db.collection("users").doc(u.uid).set(userData);
        }
        updateUI();
        showPage("app-page");
        if(u.email === MASTER_EMAIL) {
            document.getElementById('master-nav').style.display = "flex";
            loadMaster();
        }
    } else {
        showPage("auth-page");
    }
    document.getElementById('loader').style.display = "none";
});

function login() {
    auth.signInWithEmailAndPassword(email.value, pass.value).catch(e => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„"));
}
function logout() { auth.signOut(); location.reload(); }

/* UI LOGIC */
function updateUI() {
    storeName.innerText = userData.name;
    userEmail.innerText = userData.email;
    pStore.innerText = userData.name;
    
    const statusTxt = document.getElementById('status-txt');
    if(userData.active) {
        statusTxt.innerText = "Ù†Ø´Ø· âœ…"; statusTxt.style.color = "var(--s)";
        posContent.style.display = "block"; lockMsg.style.display = "none";
        expiryTxt.innerText = "ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: " + userData.expiry;
    } else {
        statusTxt.innerText = "ØºÙŠØ± Ù…ÙØ¹Ù„ âŒ"; statusTxt.style.color = "var(--d)";
        posContent.style.display = "none"; lockMsg.style.display = "block";
    }
    loadStats();
}

function view(v, e) {
    const views = ['pos-view', 'rep-view', 'support-view', 'master-view'];
    views.forEach(id => document.getElementById(id).style.display = (id === v+'-view') ? "block" : "none");
    if(e) {
        document.querySelectorAll('.nav').forEach(n => n.classList.remove('active'));
        e.currentTarget.classList.add('active');
    }
}

/* POS LOGIC */
function add() {
    let n=pname.value, b=+pbuy.value, s=+psell.value;
    if(!n || s<=0) return;
    let f=cart.find(i => i.name === n);
    f ? f.qty++ : cart.push({name:n, buy:b, sell:s, qty:1});
    render(); pname.value=pbuy.value=psell.value="";
}

function render() {
    let h="", t=0;
    cart.forEach((i, x) => {
        let sum = i.sell * i.qty; t += sum;
        h += `<tr><td>${i.name}</td><td>${i.sell}</td><td>${i.qty}</td><td>${sum}</td><td onclick="cart.splice(${x},1);render()" style="color:red;cursor:pointer">âœ–</td></tr>`;
    });
    document.getElementById('cart').innerHTML = h;
    total.innerText = t.toFixed(2);
}

async function checkout() {
    if(!cart.length) return;
    let ts = cart.reduce((a,i) => a + i.sell*i.qty, 0);
    let tb = cart.reduce((a,i) => a + i.buy*i.qty, 0);
    let inv = {
        uid: auth.currentUser.uid, items: cart, total: ts, profit: ts-tb,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        date: new Date().toLocaleString("ar-EG")
    };
    await db.collection("invoices").add(inv);
    
    let pt = "<tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th></tr>";
    cart.forEach(i => pt += `<tr><td>${i.name}</td><td>${i.sell}</td><td>${i.qty}</td></tr>`);
    pTable.innerHTML = pt; pTotal.innerText = ts; pDate.innerText = inv.date;
    window.print(); cart=[]; render(); loadStats();
}

/* MASTER CONTROL */
async function loadMaster() {
    const q = await db.collection("users").get();
    let h = "";
    q.forEach(d => {
        let u = d.data();
        h += `<tr><td>${u.email}</td><td>${u.active?'Ù…ÙØ¹Ù„':'Ù…Ø¹Ø·Ù„'}</td><td><button class="btn-p" onclick="toggleUser('${d.id}', ${!u.active})">ØªØºÙŠÙŠØ±</button></td></tr>`;
    });
    document.getElementById('master-list').innerHTML = h;
}

async function toggleUser(id, st) {
    let exp = st ? new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toLocaleDateString() : '';
    await db.collection("users").doc(id).update({ active: st, expiry: exp });
    loadMaster();
}

async function activate() {
    let k = document.getElementById('act-key').value;
    // ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ ÙˆÙ‡Ù…ÙŠ Ù„Ù„ØªØ¬Ø±Ø¨Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ø£Ùˆ Ø±Ø¨Ø·Ù‡ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
    if(k.length >= 8) { 
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù„ØªÙØ¹ÙŠÙ„Ù‡ Ù„Ùƒ.");
        window.open(`https://wa.me/201224815487?text=Ø£Ø±ØºØ¨%20ÙÙŠ%20ØªÙØ¹ÙŠÙ„%20ÙƒÙˆØ¯ÙŠ:%20${k}`);
    }
}

/* TOOLS */
function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
async function loadStats() {
    let q = await db.collection("invoices").where("uid","==",auth.currentUser.uid).orderBy("timestamp","desc").limit(10).get();
    let s=0, p=0, c=0, r="<table><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>";
    q.forEach(d => { let v=d.data(); s+=v.total; p+=v.profit; c++; r+=`<tr><td>${v.date}</td><td>${v.total}</td></tr>` });
    sSales.innerText=s.toFixed(2); sProfit.innerText=p.toFixed(2); sCount.innerText=c;
    list.innerHTML = r + "</table>";
}
setInterval(() => clock.innerText = new Date().toLocaleTimeString("ar-EG"), 1000);
</script>
</body>
</html>
